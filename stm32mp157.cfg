[virtual_sdcard]
path: ~/gcode_files

[display_status]

[pause_resume]

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  TURN_OFF_HEATERS
  CANCEL_PRINT_BASE

[neopixel my_neopixel]
pin: PD8
chain_count:1
initial_RED: 0.1
initial_GREEN: 0.9
initial_BLUE: 0.2

[mcu]
# serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_0E002B00135053424E363620-if00
serial: /dev/ttySTM1
baud: 115200
restart_method: command
#canbus_uuid: e471958aa8ee

# [display]
# lcd_type: uc1701
# cs_pin: EXP1_6
# a0_pin: EXP1_7
# contrast: 40
# encoder_pins: ^EXP2_3, ^EXP2_5
# click_pin: ^!EXP1_2
# # Some micro-controller boards may require an spi bus to be specified:
# # spi_bus: spi
# # Alternatively, some micro-controller boards may work with software spi:
# spi_software_miso_pin: EXP2_1
# spi_software_mosi_pin: EXP2_6
# spi_software_sclk_pin: EXP2_2

# [output_pin beeper]
# pin: EXP1_1

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

#####################################################################
#   X/Y Stepper Settings
#####################################################################
## X Stepper on MOTOR1
[stepper_x]
step_pin: PI5
dir_pin: !PE12
enable_pin: !PI6
rotation_distance: 40
microsteps: 16
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
# endstop_pin: tmc2209_stepper_x:virtual_endstop
endstop_pin: PD9
position_min: 0
position_endstop: 0
position_max: 235
homing_speed: 40   #Max 100
homing_retract_dist: 0 #5

[tmc5160 stepper_x]
cs_pin: PI7
sense_resistor: 0.075
run_current: 0.8
hold_current: 0.5
stealthchop_threshold: 999999
interpolate: True
spi_software_mosi_pin: PZ2
spi_software_miso_pin: PZ1
spi_software_sclk_pin: PZ0
driver_TPFD: 0

# [tmc2209 stepper_x]
# # diag_pin: ^PG3      # Set to MCU pin connected to TMC DIAG pin
# driver_SGTHRS: 100  # 255 is most sensitive value, 0 is least sensitive
# uart_pin: PI7
# sense_resistor: 0.075
# interpolate: true
# run_current: 0.8
# hold_current: 0.5
# stealthchop_threshold: 999999

#####################################################################
## Y Stepper on MOTOR2
[stepper_y]
step_pin: PZ7
dir_pin: !PZ5
enable_pin: !PZ4
rotation_distance: 40
microsteps: 16
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
# endstop_pin: tmc2209_stepper_y:virtual_endstop
endstop_pin: PE9
position_min: 0
position_endstop: 250
position_max: 250
homing_speed: 20  #Max 100
homing_retract_dist: 0 #5
homing_positive_dir: true

[tmc5160 stepper_y]
cs_pin: PZ6
sense_resistor: 0.075
run_current: 1.2
hold_current: 0.5
stealthchop_threshold: 0
interpolate: True
spi_software_mosi_pin: PZ2
spi_software_miso_pin: PZ1
spi_software_sclk_pin: PZ0

# [tmc2209 stepper_y]
# diag_pin: ^PH3      # Set to MCU pin connected to TMC DIAG pin
# driver_SGTHRS: 100  # 255 is most sensitive value, 0 is least sensitive
# uart_pin: PZ6
# sense_resistor: 0.075
# interpolate: true
# run_current: 0.8
# hold_current: 0.5
# stealthchop_threshold: 999999
 
#####################################################################
#   Z Stepper Settings
#####################################################################
## Z0 Stepper - Front Left on MOTOR3
[stepper_z]
step_pin: PF2
dir_pin: !PE4
enable_pin: !PE15
rotation_distance: 8
microsteps: 16
full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
# endstop_pin: tmc2209_stepper_z:virtual_endstop
endstop_pin: PD6
position_endstop: 0
position_max: 400
position_min: -5
homing_speed: 8
second_homing_speed: 3
homing_retract_dist: 5

[tmc5160 stepper_z]
cs_pin: PA15
sense_resistor: 0.075
run_current: 1.2
hold_current: 0.5
stealthchop_threshold: 0
interpolate: True
spi_software_mosi_pin: PZ2
spi_software_miso_pin: PZ1
spi_software_sclk_pin: PZ0

# [tmc2209 stepper_z]
# diag_pin: ^PH2      # Set to MCU pin connected to TMC DIAG pin
# driver_SGTHRS: 100  # 255 is most sensitive value, 0 is least sensitive
# uart_pin: PA15
# sense_resistor: 0.075
# interpolate: true
# run_current: 1.0
# hold_current: 0.8
# stealthchop_threshold: 999999

#####################################################################
## Z1 Stepper - Front Left on MOTOR2_2
# [stepper_z1]
# step_pin: PZ7
# dir_pin: !PZ5
# enable_pin: !PZ4
# rotation_distance: 8
# microsteps: 16
# full_steps_per_rotation:200  #set to 400 for 0.9 degree stepper
# endstop_pin: PD15

# [tmc5160 stepper_z1]
# cs_pin: PZ6
# sense_resistor: 0.075
# run_current: 1.2
# hold_current: 0.5
# stealthchop_threshold: 0
# interpolate: True
# spi_software_mosi_pin: PZ2
# spi_software_miso_pin: PZ1
# spi_software_sclk_pin: PZ0

#####################################################################
#   E0 on MOTOR5 Settings
#####################################################################
[extruder]
step_pin: PH14
dir_pin: PI4
enable_pin: !PE11
rotation_distance: 33
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PH9
##  Validate the following thermistor type to make sure it is correct
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA4
control: pid
pid_kp: 15.631
pid_ki: 0.635
pid_kd: 96.133
min_temp: 0
max_temp: 330
max_power: 1.0
min_extrude_temp: 10
max_extrude_only_distance: 500.0

# Script to change back to the main extruder
[gcode_macro T0]
gcode:
    SET_SERVO SERVO=extruder_servo angle=156        # Lift secondary extruder
    SET_GCODE_OFFSET Z=0 MOVE=1                     # Adjust z-height
    SET_GCODE_OFFSET X=0 Y=0                        # Clear X offset
    ACTIVATE_EXTRUDER EXTRUDER=extruder

# [tmc2208 extruder]
# uart_pin: PH8
# interpolate: true
# run_current: 1
# hold_current: 0.6
# stealthchop_threshold: 999999

[tmc5160 extruder]
cs_pin: PH8
sense_resistor: 0.075
run_current: 1.2
hold_current: 0.5
stealthchop_threshold: 0
interpolate: True
spi_software_mosi_pin: PZ2
spi_software_miso_pin: PZ1
spi_software_sclk_pin: PZ0


#####################################################################
#   E1 on MOTOR6 Settings
#####################################################################
[extruder1]
step_pin: PF15
dir_pin: !PG2
enable_pin: !PF12
rotation_distance: 33
microsteps: 16
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PH10
##	Validate the following thermistor type to make sure it is correct
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA0
control = pid
pid_kp = 26.213
pid_ki = 1.304
pid_kd = 131.721
min_temp: 10
max_temp: 2700
max_power: 1.0
min_extrude_temp: 15
max_extrude_only_distance: 500.0

# Script to change back to the main extruder
[gcode_macro T1]
gcode:
    SET_SERVO SERVO=extruder_servo angle=156        # Lift secondary extruder
    SET_GCODE_OFFSET Z=0 MOVE=1                     # Adjust z-height
    SET_GCODE_OFFSET X=0 Y=0                        # Clear X offset
    ACTIVATE_EXTRUDER EXTRUDER=extruder1


##	Try to keep pressure_advance below 1.0
#pressure_advance: 0.05
##	Default is 0.040, leave stock
#pressure_advance_smooth_time: 0.040

[tmc2208 extruder1]
uart_pin: PF14
interpolate: true
run_current: 1
hold_current: 0.6
stealthchop_threshold: 999999

# [tmc5160 extruder1]
# cs_pin: PF14
# sense_resistor: 0.075
# run_current: 1.2
# hold_current: 0.5
# stealthchop_threshold: 0
# interpolate: True
# spi_software_mosi_pin: PZ2
# spi_software_miso_pin: PZ1
# spi_software_sclk_pin: PZ0

#####################################################################
#   E2 on MOTOR7 Settings
#####################################################################
[extruder2]
step_pin: PH7
dir_pin: !PC13
enable_pin: !PI8
rotation_distance: 23.25
microsteps: 16
full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin: PH11
##	Validate the following thermistor type to make sure it is correct
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA6
control = pid
pid_kp = 26.213
pid_ki = 1.304
pid_kd = 131.721
min_temp: 10
max_temp: 270
max_power: 1.0
min_extrude_temp: 15
max_extrude_only_distance: 500.0

# Script to activate second extruder
[gcode_macro T2]
gcode:
    SET_GCODE_OFFSET Z=0 MOVE=1                 # Adjust z-height
    SET_SERVO SERVO=extruder_servo angle=69     # Position second extruder
    SET_GCODE_OFFSET X=-49.2  Y=7.5             # Account for different X offset
    ACTIVATE_EXTRUDER EXTRUDER=extruder2

##	Try to keep pressure_advance below 1.0
#pressure_advance: 0.05
##	Default is 0.040, leave stock
#pressure_advance_smooth_time: 0.040

# [tmc2208 extruder2]
# uart_pin: PF3
# interpolate: true
# run_current: 1
# hold_current: 0.6
# stealthchop_threshold: 999999

[tmc5160 extruder2]
cs_pin: PF3
sense_resistor: 0.075
run_current: 1.2
hold_current: 0.5
stealthchop_threshold: 0
interpolate: True
spi_software_mosi_pin: PZ2
spi_software_miso_pin: PZ1
spi_software_sclk_pin: PZ0

#####################################################################
#   E3 on MOTOR8 Settings
#####################################################################
# [extruder3]
# step_pin: PF2
# dir_pin: !PE4
# enable_pin: !PE15
# rotation_distance: 23.25
# microsteps: 16
# full_steps_per_rotation: 200	#200 for 1.8 degree, 400 for 0.9 degree
# nozzle_diameter: 0.400
# filament_diameter: 1.75
# heater_pin: PH12
# ##	Validate the following thermistor type to make sure it is correct
# sensor_type: ATC Semitec 104GT-2
# sensor_pin: PA5
# control = pid
# pid_kp = 26.213
# pid_ki = 1.304
# pid_kd = 131.721
# min_temp: -110
# max_temp: 2700
# max_power: 1.0
# min_extrude_temp: 15
# max_extrude_only_distance: 500.0

# # Script to activate second extruder
# [gcode_macro T3]
# gcode:
#     SET_GCODE_OFFSET Z=0 MOVE=1                 # Adjust z-height
#     SET_SERVO SERVO=extruder_servo angle=69     # Position second extruder
#     SET_GCODE_OFFSET X=-49.2  Y=7.5             # Account for different X offset
#     ACTIVATE_EXTRUDER EXTRUDER=extruder3

# ##	Try to keep pressure_advance below 1.0
# #pressure_advance: 0.05
# ##	Default is 0.040, leave stock
# #pressure_advance_smooth_time: 0.040

# # [tmc2208 extruder3]
# # uart_pin: PA15
# # interpolate: true
# # run_current: 1
# # hold_current: 0.6
# # stealthchop_threshold: 999999

# [tmc5160 extruder3]
# cs_pin: PA15
# sense_resistor: 0.075
# run_current: 1.2
# hold_current: 0.5
# stealthchop_threshold: 0
# interpolate: True
# spi_software_mosi_pin: PZ2
# spi_software_miso_pin: PZ1
# spi_software_sclk_pin: PZ0

#####################################################################
#   Bed Control
#####################################################################
[heater_bed]
heater_pin: PE13
control: pid
pid_Kp: 54.027
pid_Ki: 0.770
pid_Kd: 948.182
min_temp: -200
max_temp: 1300
sensor_type: ATC Semitec 104GT-2
sensor_pin: PF11

# sensor_type: MAX31865
# sensor_pin: PD5
# spi_software_mosi_pin: PZ2
# spi_software_miso_pin: PZ1
# spi_software_sclk_pin: PZ0

#tc_type: K
#tc_use_50Hz_filter: False
#tc_averaging_count: 1
#   The above parameters control the sensor parameters of MAX31856
#   chips. The defaults for each parameter are next to the parameter
#   name in the above list.
#rtd_nominal_r: 100
#rtd_reference_r: 430
#rtd_num_of_wires: 2
#rtd_use_50Hz_filter: False
#   The above parameters control the sensor parameters of MAX31865
#   chips. The defaults for each parameter are next to the parameter
#   name in the above list.



#####################################################################
#   Fan's Control
#####################################################################

[fan]
##  Print Cooling Fan - CNC_FAN0
pin: PE14
kick_start_time: 0.5
##  Depending on your fan, you may need to increase this value
##  if your fan will not start. Can change cycle_time (increase)
##  if your fan is not able to slow down effectively
off_below: 0.10

[heater_fan hotend_fan]
##  Hotend Fan - CNC_FAN1
pin: PB9
max_power: 1.0
kick_start_time: 0.5
heater: extruder
heater_temp: 50.0
#   If you are experiencing back flow, you can reduce fan_speed
fan_speed: 1.0

#[heater_fan exhaust_fan]
##  Exhaust fan - CNC_FAN3
#pin: PE13
#max_power: 1.0
#shutdown_speed: 0.0
#kick_start_time: 5.0
#heater: heater_bed
#heater_temp: 60
#fan_speed: 1.0

#####################################################################
#   Homing and Gantry Adjustment Routines
#####################################################################

[idle_timeout]
timeout: 1800

########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PG7, EXP1_2=PC0,
    EXP1_3=PB6, EXP1_4=PC3,
    EXP1_5=PF13, EXP1_6=PE8,    # Slot in the socket on this side
    EXP1_7=PD12, EXP1_8=PG9,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP3 header
    EXP2_1=PI2, EXP2_2=PB10,
    EXP2_3=PD11, EXP2_4=PD1,
    EXP2_5=PE7, EXP2_6=PI3,    # Slot in the socket on this side
    EXP2_7=PE10, EXP2_8= ,
    EXP2_9=<GND>, EXP2_10=<>,

